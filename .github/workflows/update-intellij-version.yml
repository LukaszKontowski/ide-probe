name: Update IntelliJ Version

on:
  schedule:
    - cron: '0 1 * * 1'

jobs:
  bump-intellij-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3.0.2
      - name: Update default IntelliJ version
        run: |
          sbt "update-intellij / run --java-home /usr/local/openjdk-11"
      - name: Prepare variables for PR
        run: |
          RELEASE_LINE=$(grep 'release = \"' core/driver/sources/src/main/resources/reference.conf)
          INTELLIJ_VERSION=$(awk -F'\"|\"' '{print $2}' <<< "$RELEASE_LINE")
          echo "BRANCH_NAME=update_intellij_version_to_$INTELLIJ_VERSION >> $GITHUB_ENV
          echo "PR_TITLE=Update IntelliJ version to $INTELLIJ_VERSION" >> $GITHUB_ENV
          SCALA_PLUGIN_FILE_URL="https://github.com/VirtusLab/ide-probe/blob/master/extensions/scala/tests/src/test/resources/scala.conf"
          SCALA_PLUGIN_VERSIONS_URL="https://plugins.jetbrains.com/plugin/1347-scala/versions"
          echo "PR_BODY=Updates the default IntelliJ Version to the newest release. \
            Please, check currently used version of the scala plugin: $SCALA_PLUGIN_FILE_URL \
            and verify if it is compatible with the new intelliJ IDEA version ($INTELLIJ_VERSION) here: $SCALA_PLUGIN_VERSIONS_URL. \
            If the version of the scala plugin used in $SCALA_PLUGIN_FILE_URL is NOT compatible - please update it in a separate commit." >> $GITHUB_ENV
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          branch: ${{ env.BRANCH_NAME }}
          base: "master"
          title: ${{ env.PR_TITLE }}
          body: ${{ env.PR_BODY }}
